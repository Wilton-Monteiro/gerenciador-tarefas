name: Deploy Automatizado com SonarQube

on:
  push:
    branches: [ main ]

jobs:
  build-analyze-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build e push da imagem Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: willmonteiro/gerenciador-tarefas:01
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup da chave SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Iniciar SonarQube via Docker e executar análise
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            sudo sysctl -w vm.max_map_count=262144
            sudo sysctl -w fs.file-max=65536

            docker run -d --name sonarqube-temp \
              -p 9000:9000 \
              -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
              --memory=3g \
              --ulimit nofile=65536:65536 \
              sonarqube:9.9-community

            echo "Aguardando SonarQube inicializar..."
            for i in {1..60}; do
              if curl -s http://localhost:9000/api/system/status | grep -q '"status":"UP"'; then
                echo "✅ SonarQube iniciado!"
                break
              fi
              if [ $i -eq 60 ]; then
                echo "❌ Timeout ao iniciar SonarQube"
                docker logs sonarqube-temp --tail 20
                exit 1
              fi
              sleep 10
            done

            echo "Executando análise SonarQube..."
            docker run --rm -v "$(pwd)":/usr/src \
              -v /var/run/docker.sock:/var/run/docker.sock \
              sonarsource/sonar-scanner-cli \
              -Dsonar.projectKey=gerenciador-tarefas \
              -Dsonar.projectName="Gerenciador de Tarefas" \
              -Dsonar.sources=. \
              -Dsonar.host.url=http://localhost:9000 \
              -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
              -Dsonar.exclusions=**/node_modules/**,**/*.log,**/*.md,**/dist/**,**/build/** \
              -Dsonar.qualitygate.wait=true \
              -Dsonar.qualitygate.timeout=300

            echo "Análise concluída. Limpando container do SonarQube..."
            docker stop sonarqube-temp
            docker rm sonarqube-temp
          EOF

      - name: Deploy da aplicação
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            docker stop gerenciador-tarefas 2>/dev/null || true
            docker rm gerenciador-tarefas 2>/dev/null || true
            docker stop postgres-db 2>/dev/null || true
            docker rm postgres-db 2>/dev/null || true

            docker network create app-network 2>/dev/null || true

            docker run -d --name postgres-db \
              --network app-network \
              -e POSTGRES_DB=tarefas_db \
              -e POSTGRES_USER=postgres \
              -e POSTGRES_PASSWORD=postgres123 \
              -v postgres_data:/var/lib/postgresql/data \
              postgres:15-alpine

            sleep 15

            docker run -d --name gerenciador-tarefas \
              --network app-network \
              -p 3001:3000 \
              -e DB_HOST=postgres-db \
              -e DB_PORT=5432 \
              -e DB_NAME=tarefas_db \
              -e DB_USER=postgres \
              -e DB_PASSWORD=postgres123 \
              -e NODE_ENV=production \
              willmonteiro/gerenciador-tarefas:01
          EOF

      - name: Verificar aplicação
        run: |
          echo "Aguardando aplicação inicializar..."
          sleep 30
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:3001 || echo "000")
            if [ "$STATUS" = "200" ] || [ "$STATUS" = "302" ]; then
              echo "✅ Aplicação online em http://${{ secrets.SERVER_HOST }}:3001"
              exit 0
            fi
            echo "Tentativa $i/10... Status: $STATUS"
            sleep 15
          done
          echo "❌ Aplicação não respondeu"
          exit 1
